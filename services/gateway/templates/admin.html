{% extends "base.html" %}
{% block content %}
<h1>Админ-панель</h1>
<ul class="nav nav-pills mb-3">
  <li class="nav-item"><a class="nav-link active" href="/admin">Товары</a></li>
  <li class="nav-item"><a class="nav-link" href="/admin/orders">Заказы</a></li>
  <li class="nav-item"><a class="nav-link" href="/admin/stats">Статистика</a></li>
  <li class="nav-item"><a class="nav-link" href="/admin/templates">Шаблоны</a></li>
  </ul>
<section class="mb-4">
  <h2>Создать товар</h2>
  <form id="createForm" class="row g-2">
    <div class="col-12" data-msg="create"></div>
    <div class="col-md-2"><input class="form-control" name="sku" placeholder="SKU" required /></div>
    <div class="col-md-3"><input class="form-control" name="name" placeholder="Название" required /></div>
    <div class="col-md-2"><input class="form-control" name="price" type="number" step="0.01" placeholder="Цена" required /></div>
    <div class="col-md-2"><input class="form-control" name="stock" type="number" placeholder="Остаток" value="0" /></div>
    <div class="col-md-2 form-check mt-2">
      <input class="form-check-input" type="checkbox" name="is_active" checked />
      <label class="form-check-label">Активен</label>
    </div>
    <div class="col-12">
      <label class="form-label small text-muted">Ссылки на изображения (по одному URL в строке, опционально):</label>
      <textarea class="form-control" name="image_urls" rows="2" placeholder="https://...\nhttps://..."></textarea>
    </div>
    <div class="col-12">
      <label class="form-label">Описание</label>
      <textarea class="form-control" name="description" rows="3" placeholder="Описание товара"></textarea>
    </div>
    <div class="col-md-6">
      <label class="form-label">Шаблон характеристик</label>
      <select class="form-select" name="template_id" id="templateSelect"><option value="">Без шаблона</option></select>
      <div class="form-text">Шаблоны можно управлять на странице <a href="/admin/templates">Шаблоны</a>.</div>
    </div>
    <div class="col-12">
      <label class="form-label">Характеристики (JSON)</label>
      <textarea class="form-control" name="attributes" rows="4" placeholder='{"brand":"...","color":"..."}'></textarea>
    </div>
    <div class="col-md-12 text-end"><button class="btn btn-success" type="submit">Создать</button></div>
  </form>
</section>
<section>
  <h2>Товары</h2>
  <div id="products" class="list-group"></div>
</section>

<script>
  // helpers
  function showMsg(container, text, type = 'danger') {
    if (!container) { alert(text); return; }
    container.innerHTML = `<div class="alert alert-${type} py-2 mb-2">${text}</div>`;
  }

  function populateTemplateOptions(selectEl, selectedId = null) {
    if (!selectEl) return;
    const tpls = (window._templates || []);
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Без шаблона';
    selectEl.appendChild(opt0);
    tpls.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id; opt.textContent = t.name;
      if (selectedId && String(selectedId) === String(t.id)) opt.selected = true;
      selectEl.appendChild(opt);
    });
  }

  async function loadProducts() {
    const res = await fetch('/api/products');
    const items = await res.json();
    const root = document.getElementById('products');
    root.innerHTML = '';
    items.forEach(p => {
      const el = document.createElement('div');
      el.className = 'list-group-item';
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <b>${p.name}</b> (SKU: ${p.sku}) — ${p.price} ₸ — Остаток: <b>${p.stock}</b> — ${p.is_active ? 'В продаже' : 'Снято'}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-id="${p.id}">${p.is_active ? 'Снять' : 'Вернуть'}</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="edit" data-id="${p.id}">Редактировать</button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${p.id}">Удалить</button>
          </div>
        </div>
        <form class="row g-2 mt-2 d-none" data-edit-form="${p.id}">
          <div class="col-12" data-msg="${p.id}"></div>
          <div class="col-md-2"><input class="form-control" name="sku" value="${p.sku}" /></div>
          <div class="col-md-3"><input class="form-control" name="name" value="${p.name}" /></div>
          <div class="col-md-2"><input class="form-control" name="price" type="number" step="0.01" value="${p.price}" /></div>
          <div class="col-md-2"><input class="form-control" name="stock" type="number" value="${p.stock}" /></div>
          <div class="col-md-2 form-check mt-2">
            <input class="form-check-input" type="checkbox" name="is_active" ${p.is_active ? 'checked' : ''} />
            <label class="form-check-label">Активен</label>
          </div>
          <div class="col-md-3">
            <label class="form-label">Шаблон характеристик</label>
            <select class="form-select" name="template_id" data-template-select="${p.id}"></select>
          </div>
          <div class="col-12">
            <label class="form-label small text-muted">Ссылки на изображения (по одному URL в строке)</label>
            <textarea class="form-control" name="image_urls" rows="2">${(p.images||[]).join('\n')}</textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Описание</label>
            <textarea class="form-control" name="description" rows="3">${p.description || ''}</textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Характеристики (JSON)</label>
            <textarea class="form-control" name="attributes" rows="4">${JSON.stringify(p.attributes || {}, null, 2)}</textarea>
          </div>
          <div class="col-md-1"><button class="btn btn-success btn-sm" data-action="save" data-id="${p.id}">Сохранить</button></div>
        </form>`;
      root.appendChild(el);
      // populate template selector for this form
      const sel = el.querySelector(`[data-template-select="${p.id}"]`);
      populateTemplateOptions(sel, p.template_id);
    });
  }

  document.getElementById('products').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if (action === 'toggle') {
      const resGet = await fetch(`/api/products/${id}`);
      const prod = await resGet.json();
      const res = await fetch(`/api/products/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: !prod.is_active })
      });
      if (res.ok) loadProducts(); else alert('Ошибка');
    } else if (action === 'edit') {
      const form = document.querySelector(`[data-edit-form="${id}"]`);
      if (form) form.classList.toggle('d-none');
    } else if (action === 'save') {
      e.preventDefault();
      const form = document.querySelector(`[data-edit-form="${id}"]`);
      const fd = new FormData(form);
      const msgBox = form.querySelector(`[data-msg="${id}"]`);
      if (msgBox) msgBox.innerHTML = '';
      const payload = {
        sku: fd.get('sku'),
        name: fd.get('name'),
        price: parseFloat(fd.get('price')),
        stock: parseInt(fd.get('stock') || '0', 10),
        is_active: fd.get('is_active') === 'on',
        images: (fd.get('image_urls') || '').split('\n').map(s => s.trim()).filter(Boolean)
      };
      // include description and attributes if provided
      const desc = fd.get('description');
      if (desc !== null) payload.description = desc;
      try { const attrs = JSON.parse(fd.get('attributes') || '{}'); payload.attributes = attrs; } catch {}
      const tpl = fd.get('template_id'); if (tpl) payload.template_id = tpl; else payload.template_id = null;
      const res = await fetch(`/api/products/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) { showMsg(msgBox, 'Сохранено', 'success'); loadProducts(); }
      else {
        let message = 'Ошибка сохранения';
        try {
          const t = await res.json();
          if (t && t.detail) message = t.detail;
        } catch (_) {}
        if (res.status === 409 && message === 'SKU must be unique') message = 'Товар с таким SKU уже существует';
        showMsg(msgBox, message, 'danger');
      }
    } else if (action === 'delete') {
      const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
      if (res.status === 204) loadProducts(); else alert('Ошибка удаления');
    }
  });

  document.getElementById('createForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const msgBox = e.target.querySelector('[data-msg="create"]');
    if (msgBox) msgBox.innerHTML = '';
    const payload = {
      sku: formData.get('sku'),
      name: formData.get('name'),
      price: parseFloat(formData.get('price')),
      stock: parseInt(formData.get('stock') || '0', 10),
      is_active: formData.get('is_active') === 'on',
      images: (formData.get('image_urls') || '').split('\n').map(s => s.trim()).filter(Boolean),
      description: formData.get('description') || null,
      template_id: formData.get('template_id') || null,
      attributes: (() => { try { return JSON.parse(formData.get('attributes') || '{}'); } catch { return {}; } })(),
    };
    // pre-check duplicate SKU to show friendly message
    if (payload.sku) {
      const chk = await fetch(`/api/products/sku/${encodeURIComponent(payload.sku)}`);
      if (chk.ok) { alert('Товар с таким SKU уже существует'); return; }
    }
    const res = await fetch('/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) { showMsg(msgBox, 'Создано', 'success'); e.target.reset(); loadProducts(); }
    else {
      try { const t = await res.json(); showMsg(msgBox, t.detail || JSON.stringify(t)); }
      catch { const t = await res.text(); showMsg(msgBox, 'Ошибка: ' + t); }
    }
  });

  // Load templates into selector and then products
  async function loadTemplates() {
    const res = await fetch('/api/templates');
    if (!res.ok) return;
    const arr = await res.json();
    window._templates = arr;
    const sel = document.getElementById('templateSelect');
    arr.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id; opt.textContent = t.name; sel.appendChild(opt);
    });
    sel.addEventListener('change', () => {
      const id = sel.value;
      const ta = document.querySelector('textarea[name="attributes"]');
      const tpl = arr.find(x => x.id === id);
      if (tpl && tpl.schema && ta) {
        const skeleton = Object.fromEntries(Object.keys(tpl.schema || {}).map(k => [k, '']));
        ta.value = JSON.stringify(skeleton, null, 2);
      }
    });
    // after templates loaded populate product list (so edit forms can get template options)
    await loadProducts();
  }
  loadTemplates();
</script>
{% endblock %}
