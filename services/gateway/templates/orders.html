{% extends "base.html" %}
{% block content %}
<h1>Мои заказы</h1>
<div id="orders"></div>
<script>
  async function loadOrders() {
    const res = await fetch('/api/orders');
    const root = document.getElementById('orders');
    if (!res.ok) { root.textContent = 'Ошибка загрузки'; return; }
    const arr = await res.json();
    if (!arr.length) { root.textContent = 'Заказов пока нет'; return; }
    root.innerHTML = '';
    arr.forEach(o => {
      const el = document.createElement('div');
      el.className = 'card mb-3';
      const created = new Date(o.created_at).toLocaleString();
      el.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <div><b>Заказ #${o.id}</b> — ${created}</div>
              <div>Статус: <span class="badge ${o.status==='canceled' ? 'text-bg-danger' : 'text-bg-success'}">${o.status}</span></div>
            </div>
            <div class="text-end">Итого: <b>${formatPrice(o.total)} ₸</b></div>
          </div>
          <a class="btn btn-sm btn-outline-primary mt-2" href="/orders/${o.id}">Детали</a>
          ${o.status !== 'canceled' ? `<button class="btn btn-sm btn-outline-danger mt-2 ms-2" data-cancel="${o.id}">Отменить</button>` : ''}
        </div>`;
      root.appendChild(el);
    });
  }
  loadOrders();
  document.getElementById('orders').addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-cancel]');
    if (!btn) return;
    const id = btn.getAttribute('data-cancel');
    const res = await fetch(`/api/orders/${id}/cancel`, { method: 'PATCH' });
    if (res.ok) loadOrders();
    else alert('Не удалось отменить заказ');
  });
</script>
{% endblock %}
